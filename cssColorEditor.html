<!doctype html>
<head>
    <title>CSS Color Editor</title>
    <style>
        @import 'http://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dijit/themes/claro/claro.css';
        @import 'http://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dojox/widget/ColorPicker/ColorPicker.css';

        html, body, #main {
            width: 100%; /* make the body expand to fill the visible window */
            height: 100%;
            overflow: hidden; /* erase window level scrollbars */
            padding: 0 0 0 0;
            margin: 0 0 0 0;
            font: 10pt Arial, Myriad, Tahoma, Verdana, sans-serif;
        }

        #content span {
            border: 1px solid transparent;
            border-radius: 5px 5px 5px 5px;
            display: inline-block;
            margin: 2px 0;
            padding: 4px;
            font-style: normal;
            color: #000;
        }

        #content span.selected {
            box-shadow: 3px 3px 3px #888;
        }

        .left {
            float: left;
        }

        .buttons {
            margin-left: 2em;
        }

        .buttons .dijitButton {
            width: 140px;
        }

        .buttons .dijitButton .dijitButtonNode {
            width: 100%;
        }

        #main-bottom {
            color: #888;
        }

        #saveResult, #openResult {
            padding-left: 2em;
        }

    </style>

    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dojo/dojo.xd.js" data-dojo-config="isDebug:true, parseOnLoad: true"></script>
    <script>
        dojo.require('dojox.widget.ColorPicker');
        dojo.require('dijit.form.Button');
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("dojo.io.iframe");
    </script>
</head>
<body class="claro">
<div id="main" data-dojo-type="dijit.layout.BorderContainer" data-dojo-props='design:"sidebar"'>
    <div role="banner" data-dojo-type="dijit.layout.ContentPane" data-dojo-props='id:"border1-top", region:"top", style:"height: 170px;padding: 1em;", splitter:true'>
        <div id="picker"
             data-dojo-type="dojox.widget.ColorPicker"
             data-dojo-id="picker"
             data-dojo-props="'class': 'left'"></div>
        <div class="buttons left">
            <div>
                <button data-dojo-type="dijit.form.Button" data-dojo-id="openBtn">Open file</button>
            </div>
            <div>
                <button data-dojo-type="dijit.form.Button" data-dojo-id="saveBtn">Save file</button>
            </div>
        </div>
    </div>
    <div role="main" data-dojo-type="dijit.layout.ContentPane" data-dojo-props='id:"border1-center", region:"center", style:"padding: 1em;"'>
        <code>
            <pre id="content"></pre>
        </code>
    </div>
    <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props='id:"main-bottom", region:"bottom", style:"height: 1.5em;", splitter:true'>
        <span id="hint">HINT: use CTRL+click to copy colors</span><span id="openResult">No file selected</span><span id="saveResult"></span>
    </div>

</div>

<script>
    var sourceFile;
    var destFile;

    var openFile = function ()
    {
        netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
        Components.utils.import("resource://gre/modules/NetUtil.jsm");
        Components.utils.import("resource://gre/modules/FileUtils.jsm");
        var nsIFilePicker = Components.interfaces.nsIFilePicker;
        var filePicker = Components.classes["@mozilla.org/filepicker;1"].createInstance(nsIFilePicker);
        filePicker.init(window, 'Open file...', nsIFilePicker.modeOpen);
        var result = filePicker.show();

        if (result != nsIFilePicker.returnOK)
        {
            console.debug('nsIFilePicker.return: ' + result);
            return;
        }
        var file = filePicker.file;
        var openResult = dojo.byId('openResult');
        sourceFile = filePicker.fileURL.path;
        console.debug('Reading file: \'' + filePicker.fileURL.path + '\'');

        dojo.xhrGet({
            url: sourceFile,
            handleAs: 'text',
            load: function (response)
            {
                var data = response.replace('&', '&amp;').replace('>', '&gt;').replace('<', '&lt;').replace(/#([0-9a-zA-Z]{6})/gi, '<span style=\'background-color: #$1;\'>#$1</span>');
                //console.debug(data);
                var themeEl = dojo.byId('content');
                themeEl.innerHTML = data;
                var elements = dojo.query('span', themeEl);
                elements.forEach(function (span)
                {
                    dojo.connect(span, 'onclick', function (evt)
                    {
                        console.debug(evt);
                        if (evt.ctrlKey)
                        {
                            dojo.query('span.selected', themeEl).forEach(function (prevSpan)
                            {
                                dojo.style(span, 'backgroundColor', dojo.style(prevSpan, 'backgroundColor'));
                                span.innerHTML = prevSpan.innerHTML;
                            });
                        }
                        dojo.query('span', dojo.byId('content')).forEach(function (el)
                        {
                            dojo.removeClass(el, 'selected');
                        });
                        dojo.addClass(span, 'selected');
                        picker.set('value', dojo.style(span, 'backgroundColor'));
                    });

                });
                if (elements.length > 0)
                {
                    dojo.addClass(elements[0], 'selected');
                    picker.set('value', dojo.style(elements[0], 'backgroundColor'));
                }
                openResult.innerHTML = 'Content file: \'' + sourceFile.replace('&', '&amp;').replace('>', '&gt;').replace('<', '&lt;') + '\'';
            }
        });


    }
    var saveData = function ()
    {
        if (!sourceFile)
        {
            return;
        }
        if (!destFile)
        {
            destFile = sourceFile;
        }
        netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
        Components.utils.import("resource://gre/modules/NetUtil.jsm");
        Components.utils.import("resource://gre/modules/FileUtils.jsm");
        // file is nsIFile, data is a string

        // You can also optionally pass a flags parameter here. It defaults to
        // FileUtils.MODE_WRONLY | FileUtils.MODE_CREATE | FileUtils.MODE_TRUNCATE;
        var nsIFilePicker = Components.interfaces.nsIFilePicker;
        var filePicker = Components.classes["@mozilla.org/filepicker;1"].createInstance(nsIFilePicker);
        filePicker.init(window, 'Save file as...', nsIFilePicker.modeSave);
        filePicker.defaultString = destFile;
        var result = filePicker.show();

        if (result == nsIFilePicker.returnCancel)
        {
            console.debug('nsIFilePicker.return: ' + result);
            return;
        }
        var file = filePicker.file;
        destFile = filePicker.fileURL.path;
        var saveResult = dojo.byId('saveResult');
        console.debug('Content saved to file: \'' + filePicker.fileURL.path + '\'');
        saveResult.innerHTML = 'Content saved to file: \'' + filePicker.fileURL.path.replace('>', '&gt;').replace('<', '&lt;') + '\'';

        //var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
        //file.initWithPath("/home/kiuma/foo.js");
        var ostream = FileUtils.openSafeFileOutputStream(file);

        var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].
                createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
        converter.charset = "UTF-8";

        var data = dojo.byId('content').innerHTML.replace(/(<span[^>]*>)([^<]*)(<\/span>)/gi, "$2").replace('&gt;', '>').replace('&lt;', '<').replace('&amp;', '&');
        var istream = converter.convertToInputStream(data);

        // The last argument (the callback) is optional.
        try
        {
            NetUtil.asyncCopy(istream, ostream, function(status)
            {
                if (!Components.isSuccessCode(status))
                {
                    // Handle error!
                    console.debug('Error: ' + status);
                    return;
                }
                var saveResult = dojo.byId('saveResult');

                dojo.fx.chain([
                    dojo.fadeIn({ node:saveResult , duration: 1000}),
                    dojo.fadeOut({ node:saveResult , delay: 1000, duration: 1000})
                ]).play();

                // Data has been written to the file.
            });
        }
        catch (e)
        {
            console.debug(e.message);
        }
    };

    dojo.ready(function ()
    {
        //netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect UniversalPreferencesRead UniversalBrowserWrite UniversalPreferencesRead UniversalPreferencesWrite CapabilityPreferencesAccess UniversalFileRead');
        document.addEventListener('inputReady', function (evt)
        {
            dojo.byId('content').innerHTML = evt.data;
            dojo.byId('openResult').innerHTML = 'Content file: \'' + filePicker.fileURL.path.replace('>', '&gt;').replace('<', '&lt;') + '\'';
        });
        var themeEl = dojo.byId('content');


        dojo.connect(saveBtn, 'onClick', saveData);
        dojo.connect(openBtn, 'onClick', openFile);
        dojo.connect(picker, 'onChange', function (value)
        {
            dojo.query('span.selected', themeEl).forEach(function (span)
            {
                if (value != dojo.style(span, 'backgroundColor'))
                {
                    dojo.style(span, 'backgroundColor', value);
                    span.innerHTML = value;
                }
            });
        });
    });
</script>
</body>
</html>